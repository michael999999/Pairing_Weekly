#「年度全域唯一最佳」腳本可以加上平行化，將「訓練窗內的 L×Z 搜尋」同時分派到多個行程，大幅縮短搜尋時間。
下面給你一版已平行化的 wf_yearly_global_pick.py，並說明關鍵設計與使用方式。

重點說明

平行化層級：每個訓練窗中，對所有 (L, Z) 組合並行搜尋其最佳 θ（z_entry, z_exit, time_stop）。每個工作進程會：
建立對應 L×Z 的 Loader
為訓練窗內每一年生成 YearPanel
掃參數網格，得到該 L×Z 的最佳分數與參數
全域最佳選擇：彙整所有 L×Z 的最佳成績，取 Sharpe → CumReturn → AnnVol 的排序，挑出唯一本期 (L*, Z*, θ*)，再用它做當年 OOS。
參數
--n-jobs N：平行工作數（預設 8）
--backend loky|threading：預設 loky（多製程）；若 I/O 磁碟競爭較大，可降為較小的 n_jobs，或改 threading（共享記憶體，但受 GIL 限制；pandas/numpy 運算多半能部分釋放 GIL，仍可能有加速）
建議 n_jobs：4–8（依機器 CPU/磁碟而定）。太高可能造成快取檔讀取 I/O 爭用。
更新後程式：src/wf_yearly_global_pick.py

已整合平行化（joblib）
註解繁體中文；螢幕/日誌英文
僅在「訓練窗搜尋 L×Z 最佳 θ」的步驟平行；逐年 OOS 聚合與列印保持單執行緒
你可以直接覆蓋之前同名檔案。

使用範例

讓 2016–2019 都有 OOS（train-periods=1），8 個平行工作

python -m src.wf_yearly_global_pick ^
--top-csv cache\top_pairs_annual.csv ^
--cache-root cache\rolling_cache_weekly_v1 ^
--price-type log ^
--formation-lengths all ^
--z-windows all ^
--trading-periods "2013,2014,2015,2016,2017,2018,2019" ^
--train-periods 3 ^
--grid-z-entry "0.5,1.0,1.5,2.0,2.5,3.0" ^
--grid-z-exit "0.0,0.5,1.0,1.5,2.0,2.5" ^
--grid-time-stop "none,9" ^
--cost-bps 5 ^
--capital 1000000 ^
--n-pairs-cap 60 ^
--n-jobs 12 ^
--backend loky ^
--out-dir reports\wf_yearly_global_pick_5bps_tp3

--ignore-selection-formation ^