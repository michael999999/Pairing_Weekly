# 周線配對交易（Weekly Pairs Trading）全量流程 README

本文件說明：從原始日收盤價，到週頻快取、單次回測、批次回測、參數搜尋、走動式樣本外、圖表輸出，完整的端到端流程與每個階段的指令。所有範例皆以「全量資料」為例。

關鍵設計
- 價格資料：日頻 adjusted close（data/prices.pkl，寬表）
- 週頻執行語義：T+1 收盤成交（週末出訊號，下一交易日收盤建倉；PnL 用 pos.shift(1) × r）
- 週頻估計：z 僅在週末有值；β 於週末估，從 T+1 起 forward-fill 至下次週末前
- 成本定義：每腿單邊 cost_bps（預設 5 bps，可配置）
- 註解：程式碼註解為繁體中文；標準輸出與 log 為英文

相依環境
- Python 3.9+（建議）
- 套件：pandas、numpy、joblib、matplotlib、seaborn
- 專案結構（關鍵路徑）
  - data/prices.pkl（日頻 adjusted close，DataFrame：DatetimeIndex × symbols）
  - cache/top_pairs.csv（原始半年度配對名單）
  - src/（回測與工具腳本）
  - reports/（輸出報表）
  - cache/rolling_cache_weekly_v1/（週頻 pair-cache）

提醒
- 在專案根目錄執行指令（例：C:\DataDisk\Pair_Weekly）
- 以模組方式啟動：python -m src.module_name（src 需含 __init__.py）
- Windows CMD 換行用 ^；PowerShell 用 `；Linux/macOS 用 \

────────────────────────────────────────────────────────────────────────

第 0 步｜資料與目錄檢查
- data/prices.pkl：日頻 adjusted close，欄名為股票代碼
- cache/top_pairs.csv：半年度配對名單，至少含 stock1, stock2, formation_length, trading_period (YYYYH1/HH2), rank_final

目錄結構建議
- data/
- cache/
- src/
- reports/

────────────────────────────────────────────────────────────────────────

第 1 步｜由日價產生週頻基準價（W_Close, T1_Close）
輸入：data/prices.pkl（日頻收盤）
輸出：data/weekly_prices.pkl（週末收盤與下一交易日收盤；MultiIndex 欄位：[Symbol, {W_Close, T1_Close}]）

命令
- Windows（CMD）
  - python scripts\build_weekly_prices.py --input data\prices.pkl --output data\weekly_prices.pkl --freq W-FRI
- Linux/macOS
  - python scripts/build_weekly_prices.py --input data/prices.pkl --output data/weekly_prices.pkl --freq W-FRI

說明
- W_Close：該週最後交易日收盤
- T1_Close：該週之後下一交易日收盤（遇假期順延）
- 末週多為無 T1_Close（NaN），當週不可交易（在回測層剔除）

────────────────────────────────────────────────────────────────────────

第 2 步｜將半年度配對名單轉為年度（沿用 H1 至全年、丟棄 H2）
輸入：cache/top_pairs.csv
輸出：cache/top_pairs_annual.csv（trading_period 改 YYYY；trading_start=YYYY-01-01、trading_end=YYYY-12-31；按 formation_length、trading_period 排序）

命令
- python scripts\convert_pairs_to_annual.py --input cache\top_pairs.csv --output cache\top_pairs_annual.csv

────────────────────────────────────────────────────────────────────────

第 3 步｜建立週頻 pair-cache（多組 Formation_Length × Z-Window）
輸入：data/prices.pkl、data/weekly_prices.pkl、cache/top_pairs_annual.csv
輸出：cache/rolling_cache_weekly_v1/L{L}/Z{Z}/pairs/{pair_id}.pkl

命令（全量建立 5×5 組合：L=2,2.5,3,3.5,4 × Z=4,8,13,26,52）
- python scripts\build_weekly_pair_cache.py ^
  --prices data\prices.pkl ^
  --weekly data\weekly_prices.pkl ^
  --pairs cache\top_pairs_annual.csv ^
  --root cache\rolling_cache_weekly_v1 ^
  --formation-lengths "2,2.5,3,3.5,4" ^
  --z-windows-weeks "4,8,13,26,52" ^
  --overwrite-mode overwrite

重點
- 每個 pair 檔含：z（僅週末有值）、beta（日頻有效；T+1 起 ffill）、px_x/px_y（log）、px_x_raw/px_y_raw、旗標（week_end_flag、t1_tradeable_flag）
- 路徑分層：L200/Z013 代表 L=2.00 年、Z=13 週之組合

────────────────────────────────────────────────────────────────────────

第 4 步｜單次回測（Smoke test）
以某組（例：L=2.0, Z=13）與特定年度（例 2019）快速驗證

命令
- python -m src.backtest_full ^
  --top-csv cache\top_pairs_annual.csv ^
  --cache-root cache\rolling_cache_weekly_v1 ^
  --price-type log ^
  --formation-lengths "2" ^
  --trading-periods 2019 ^
  --z-window 13 ^
  --time-stop-weeks 6 ^
  --ignore-selection-formation ^
  --out-dir reports\weekly_smoke_L2_Z13

應見結果
- 總表：reports/.../total_metrics.json
- 逐 combo：reports/.../combos_metrics.csv
- 淨值曲線：equity_curve_total.csv
- 檢查：
  - 第一個成交日（T+1）當天報酬為 0（因 pos.shift(1) × r）
  - β 呈階梯狀，從週末後 T+1 起才生效

────────────────────────────────────────────────────────────────────────

第 5 步｜批次回測（多 Z-Window）
一次跑 Z ∈ {4,8,13,26,52}，每次 run 內可同時含多個 L

命令
- python -m src.batch_weekly ^
  --top-csv cache\top_pairs_annual.csv ^
  --cache-root cache\rolling_cache_weekly_v1 ^
  --price-type log ^
  --formation-lengths "2,2.5,3,3.5,4" ^
  --trading-periods all ^
  --z-windows "4,8,13,26,52" ^
  --time-stop-weeks 6 ^
  --ignore-selection-formation ^
  --out-root reports\weekly_batch

輸出
- 每個 Z 的輸出目錄：reports/weekly_batch/Z004, Z008, Z013, Z026, Z052
- 彙整：reports/weekly_batch/_summary/
  - combined_metrics.csv（整併各 Z 的 combos_metrics）
  - pivot_sharpe.csv/PNG、pivot_mdd.csv/PNG（L×Z 熱力圖）

────────────────────────────────────────────────────────────────────────

第 6 步｜參數搜尋與彙總（以 Set = L × Z 為單位）
在各 Set 內搜尋 θ* = (z_entry, z_exit, time_stop_weeks)，以全期 Sharpe 優先（平手看總報酬、再看年化波動）。額外精準計算逐筆交易層級 Profit Factor、勝率、平均持有天數。

命令（全量）
- python -m src.grid_search_weekly ^
  --top-csv cache\top_pairs_annual.csv ^
  --cache-root cache\rolling_cache_weekly_v1 ^
  --price-type log ^
  --formation-lengths all ^
  --z-windows all ^
  --trading-periods all ^
  --grid-z-entry "0.5,1.0,1.5,2.0,2.5" ^
  --grid-z-exit "0.0,0.5" ^
  --grid-time-stop "none,6" ^
  --cost-bps 5 ^
  --capital 1000000 ^
  --n-pairs-cap 60 ^
  --ignore-selection-formation ^
  --n-jobs 8 ^
  --backend loky ^
  --out-dir reports\gridsearch_weekly

輸出
- 每個 Set：reports/gridsearch_weekly/Lxxx_Zyyy/
  - best_params.json、equity_curve_full.csv、yearly_metrics.csv、no_trade_years.txt
- 總表：reports/gridsearch_weekly/_summary/best_sets.csv
- 螢幕表格：整齊對齊的 25 行（每個 Set 一行），含
  - formation_length, z_window, z_entry, z_exit, time_stop, cost_bps, cum_return, ann_return, ann_vol, sharpe, max_drawdown, total_trades（pair 級總筆數）, win_rate, avg_duration_days, profit_factor

重要說明（total_trades 定義）
- total_trades 為「配對層級 round-trip 總和」。例如每年 10 對 × 5 年 = 50 個 pair-year；若每個 pair-year 平均 7 筆交易，total_trades≈350，合理。這不是「投組層級」的事件數。

────────────────────────────────────────────────────────────────────────

第 7 步｜論文圖表生成（GridSearch 結果）
從 best_sets.csv 與各 set 檔案自動繪圖（含 _GSPC 買進持有對比）

命令
- python -m src.plot_thesis_figs ^
  --grid-root reports\gridsearch_weekly ^
  --prices data\prices.pkl ^
  --benchmark-symbol _GSPC ^
  --out-dir reports\thesis_figs

輸出
- L×Z 熱力圖：Sharpe、MDD（CSV+PNG）
- 針對 Sharpe 最佳的 Set：
  - 年度收益柱狀（策略 vs _GSPC）
  - 年度 Sharpe 條圖
  - 全期累積淨值（策略 vs _GSPC）
  - 滾動 Sharpe（252d、亦可輸出 126d）
  - 年度超額報酬（策略 − _GSPC）
  - 日報酬分布（策略 vs _GSPC）
  - 回撤時間序列（策略 vs _GSPC）
- 輸出位置：reports/thesis_figs/*.png

備註：rolling Sharpe 使用日頻視窗（126d ≈ 半年、252d ≈ 一年），因 PnL 以日頻累積；若要週頻視角可先聚合為週報酬再計 26w/52w。

────────────────────────────────────────────────────────────────────────

第 8 步｜走動式（Walk-Forward）樣本外選擇／評估（Set 層）
依年度排序，採「先定參、後評估」，每次用過去 n 年（train-periods）做年度 Leave-One-Out 交叉驗證挑 θ*，再在下一年測試。聚合所有 OOS，計算 OOS Sharpe、PSR（非正態修正）、p-value；對每個 W 用 BH-FDR 控制 FDR，選出最終 L。

命令（全量走動式）
- python -m src.walkforward_weekly ^
  --top-csv cache\top_pairs_annual.csv ^
  --cache-root cache\rolling_cache_weekly_v1 ^
  --price-type log ^
  --formation-lengths all ^
  --z-windows all ^
  --trading-periods all ^
  --train-periods 3 ^
  --grid-z-entry "0.5,1.0,1.5,2.0,2.5" ^
  --grid-z-exit "0.0,0.5" ^
  --grid-time-stop "none,6" ^
  --cost-bps 5 ^
  --capital 1000000 ^
  --n-pairs-cap 60 ^
  --ignore-selection-formation ^
  --n-jobs 8 ^
  --backend loky ^
  --fdr-q 0.1 ^
  --out-dir reports\walkforward_weekly

輸出
- 每個 Set：reports/walkforward_weekly/Lxxx_Zyyy/
  - wf_oos_params.csv（逐年 OOS 參數與績效；年份為整數字串；time_stop 右對齊列印）
  - wf_oos_returns.csv（OOS 日報酬與累積淨值）
  - wf_summary.json（OOS 全期：Sharpe、AnnRet/Vol、MDD、PSR、p-value）
- 摘要：reports/walkforward_weekly/_summary/
  - wf_sets_summary.csv（各 Set 的 OOS 全期指標+PSR/p）
  - wf_final_picks_by_W.csv（每個 W 的最終 L、挑選原因）

螢幕輸出（每個 W 列出所選 L）
- 列出 2015–2019（依你的資料範圍）的年度 θ 與績效，最後印 Total OOS 行（Sharpe/AnnRet/AnnVol/MDD）

────────────────────────────────────────────────────────────────────────

第 9 步｜走動式 Picks 綜合圖（每個 W 的最終 L）
從 wf_final_picks_by_W.csv 自動生成每個 pick 的 2×2 綜合圖（年度 vs 基準、累積淨值 vs 基準、滾動 Sharpe、回撤）

命令
- python -m src.wf_plot_picks ^
  --wf-root reports\walkforward_weekly ^
  --prices data\prices.pkl ^
  --benchmark-symbol _GSPC ^
  --out-dir reports\walkforward_figs

輸出
- 報告圖：reports/walkforward_figs/wf_pick_Lxxx_Zyyy.png

────────────────────────────────────────────────────────────────────────

品質檢核（強烈建議）
- 時間語義：
  - z 僅週末（週五或最後交易日）有值
  - β 在週末後 T+1 起生效（回測再用 beta.shift(1)）
  - PnL 使用 pos.shift(1) × r（成交日不吃當日報酬）
- 邊界：
  - 最末週多無 T1_Close（不可交易）
  - 任一腿 T+1 缺價（停牌等）當週應不得實際下單（可擴充用 t1_tradeable_flag 遮罩）
- 名單覆蓋：
  - 用 scripts/period_coverage_heatmap.py 產出年度 × formation_length 覆蓋度，確保樣本充足
- 成本敏感度：
  - 將 cost_bps 調至 10、20 bps 對比淨值侵蝕

────────────────────────────────────────────────────────────────────────

參數名詞表
- formation_length（L）：形成窗長度（年），例 2.0=2 年
- z_window（Z）：殘差 z-score 標準化的週滾動窗（週），例 52=一年
- z_entry / z_exit：進出場 z 門檻
- time_stop_weeks：時間停損（週）；回測內換算成 ceil(weeks × 5) 交易日
- price_type：log（diff 計算報酬）或 raw（pct_change）
- cost_bps：每腿單邊成本（基點）
- total_trades（gridsearch 輸出）：配對層級 round-trip 總筆數（pair-level sum）
- PSR：Probabilistic Sharpe Ratio（非正態修正），p-value=1−PSR

────────────────────────────────────────────────────────────────────────

常見疑難排解
- ModuleNotFoundError: 請確認以模組方式執行（python -m src.xxx）且 src 內有 __init__.py
- 週頻快取缺檔：檢查 cache\rolling_cache_weekly_v1\Lxxx\Zyyy\pairs 是否齊全；或重跑建置（--overwrite-mode clean/overwrite/skip）
- T+1 旗標越界：建置器已採向量化與邊界過濾；如仍遇異常請檢查 weekly_prices 的 index 與日價索引是否對齊
- total_trades 過大？請參考上面的「定義說明」，這是 pair 級筆數；若需投組事件日，可加自訂統計（未預設輸出）

────────────────────────────────────────────────────────────────────────

範例：從零到論文圖（全量）
1) 週價檔
- python scripts\build_weekly_prices.py --input data\prices.pkl --output data\weekly_prices.pkl

2) 年度化配對名單
- python scripts\convert_pairs_to_annual.py --input cache\top_pairs.csv --output cache\top_pairs_annual.csv

3) 週頻 pair-cache（全 L×Z）
- python scripts\build_weekly_pair_cache.py --prices data\prices.pkl --weekly data\weekly_prices.pkl --pairs cache\top_pairs_annual.csv --root cache\rolling_cache_weekly_v1 --formation-lengths "2,2.5,3,3.5,4" --z-windows-weeks "4,8,13,26,52" --overwrite-mode overwrite

4) 單次回測（驗證）
- python -m src.backtest_full --top-csv cache\top_pairs_annual.csv --cache-root cache\rolling_cache_weekly_v1 --price-type log --formation-lengths "2" --trading-periods 2019 --z-window 13 --time-stop-weeks 6 --ignore-selection-formation --out-dir reports\weekly_smoke_L2_Z13

5) 批次回測（多 Z）
- python -m src.batch_weekly --top-csv cache\top_pairs_annual.csv --cache-root cache\rolling_cache_weekly_v1 --price-type log --formation-lengths "2,2.5,3,3.5,4" --trading-periods all --z-windows "4,8,13,26,52" --time-stop-weeks 6 --ignore-selection-formation --out-root reports\weekly_batch

6) 參數搜尋（Set 內網格）
- python -m src.grid_search_weekly --top-csv cache\top_pairs_annual.csv --cache-root cache\rolling_cache_weekly_v1 --price-type log --formation-lengths all --z-windows all --trading-periods all --grid-z-entry "0.5,1.0,1.5,2.0,2.5" --grid-z-exit "0.0,0.5" --grid-time-stop "none,6" --cost-bps 5 --capital 1000000 --n-pairs-cap 60 --ignore-selection-formation --n-jobs 8 --backend loky --out-dir reports\gridsearch_weekly

7) 論文圖表（GridSearch）
- python -m src.plot_thesis_figs --grid-root reports\gridsearch_weekly --prices data\prices.pkl --benchmark-symbol _GSPC --out-dir reports\thesis_figs

8) 走動式（WF）
- python -m src.walkforward_weekly --top-csv cache\top_pairs_annual.csv --cache-root cache\rolling_cache_weekly_v1 --price-type log --formation-lengths all --z-windows all --trading-periods all --train-periods 3 --grid-z-entry "0.5,1.0,1.5,2.0,2.5" --grid-z-exit "0.0,0.5" --grid-time-stop "none,6" --cost-bps 5 --capital 1000000 --n-pairs-cap 60 --ignore-selection-formation --n-jobs 8 --backend loky --fdr-q 0.1 --out-dir reports\walkforward_weekly

9) 走動式 Picks 綜合圖
- python -m src.wf_plot_picks --wf-root reports\walkforward_weekly --prices data\prices.pkl --benchmark-symbol _GSPC --out-dir reports\walkforward_figs

────────────────────────────────────────────────────────────────────────

備註
- 本專案僅供學術研究；非投資建議
- 請在論文中清楚註明關鍵假設（T+1 收盤成交、成本模型、名單形成與交易窗邊界處理）與任何已知限制（借券費、停牌日、成交可得性）